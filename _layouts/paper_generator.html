<!DOCTYPE html>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/latex.js@0.12.4/dist/css/article.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/latex.js@0.12.4/dist/css/base.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/latex.js@0.12.4/dist/css/book.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/latex.js@0.12.4/dist/css/katex.css">

<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="/public/data.js"></script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.js"></script>

<style>
    p#paper {
        padding: 100px;
        display: inline-block;
        width: 600px;
        border: 1px solid red;
        margin-right: 2em;
    }
</style>

<h1>Welcome to my paper generator</h1>

<div class="row align-items-center">
    <div class="col-sm">
        <div id="slider-new-york-times"></div>
    </div>
</div>

<div>
    <p id="paper"></p>
</div>

<script>
    var width = 1000;
    var height = 200;
    var margin = {top: 20, right: 50, bottom: 50, left: 40};

    var barsNumber = 81;

    var min = -3.1;
    var max = 5;
    var histGenerator = d3.bin()
        .domain([min, max])    // Set the domain to cover the entire intervall [0,1]
        .thresholds(barsNumber);

    var hist = histGenerator(data.map(x => x.effect));

    var dataNewYorkTimes = hist.map(d => ({
            effect: d.x0,
            value: d.length || 0
        }));

    var svg = d3
        .select('div#slider-new-york-times')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    var padding = 0.1;

    var xBand = d3
        .scaleBand()
        .domain(dataNewYorkTimes.map(d => d.effect))
        .range([margin.left, width - margin.right])
        .padding(padding);

    var xLinear = d3
        .scaleLinear()
        .domain([min, max])
        .range([
            margin.left + xBand.bandwidth() / 2 + xBand.step() * padding - 0.5,
            width -
                margin.right -
                xBand.bandwidth() / 2 -
                xBand.step() * padding -
                0.5,
        ]);

    var y = d3
        .scaleLinear()
        .domain([0, d3.max(dataNewYorkTimes, d => d.value)])
        .nice()
        .range([height - margin.bottom, margin.top]);

    var yAxis = g =>
        g
            .attr('transform', `translate(${width - margin.right},0)`)
            .call(
                d3
                    .axisRight(y)
                    .tickValues([1e4])
                    .tickFormat(d3.format('($.2s'))
            )
            .call(g => g.select('.domain').remove());

    var slider = g =>
        g.attr('transform', `translate(0,${height - margin.bottom})`).call(
            d3
            .sliderBottom(xLinear)
            .min(min)
            .max(max - 0.1)
            .step(0.1)
            .tickFormat(d3.format('.2'))
            .ticks(10)
            .default(0)
            .on('onchange', value => draw(value))
        );

    var bars = svg
        .append('g')
        .selectAll('rect')
        .data(dataNewYorkTimes);

    var barsEnter = bars
        .enter()
        .append('rect')
        .attr('x', d => xBand(d.effect))
        .attr('y', d => y(d.value) - 10)
        .attr('height', d => y(0) - y(d.value))
        .attr('width', xBand.bandwidth() - 1);

    svg.append('g').call(yAxis);
    svg.append('g').call(slider);

    svg.select('.track-overlay').attr('stroke-width', 120); // Ensure drag zone covers everything

    function drawPaper(i) {
        let generator = new latexjs.HtmlGenerator({hyphenate: true});

        fetch('/public/paper.txt')
            .then(response => response.text())
            .then(text => {
                let replaced = text.replace("${value}", dataNewYorkTimes[i].value);
                var res = latexjs.parse(replaced, {generator: generator}).htmlDocument().documentElement.outerHTML;
                d3.select('p#paper').html(res);
            });
    }

    var draw = selected => {
        var i = Math.round((selected - min) * 10);
        var bar = (Math.round(selected * 10)) / 10;

        barsEnter
            .merge(bars)
            .attr('fill', d => (d.effect === bar ? '#94210a' : '#e0e0e0'));

        d3.select('p#value-new-york-times').text(dataNewYorkTimes[i].value);

        drawPaper(i);
    };

    draw(0);
    drawPaper(0);

</script>
